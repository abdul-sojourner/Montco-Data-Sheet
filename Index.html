<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montgomery County AAPI Community Explorer</title>
    
    <!-- 1. MAIN APP DEPENDENCIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. DASHBOARD DEPENDENCIES -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js & Plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        /* --- MAIN LAYOUT STYLES --- */
        body {
            /* Ensure main body isn't affected by dashboard styles */
            display: block !important; 
            margin: 0;
            font-family: 'Inter', sans-serif;
        }

        /* Custom Tab Styles */
        .tab-btn {
            color: #ccfbf1; /* Teal-100 */
            transition: all 0.2s ease-in-out;
            border-bottom: 4px solid transparent;
            text-decoration: none;
        }
        
        .tab-btn:hover {
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px 4px 0 0;
        }

        .tab-btn.active {
            border-bottom: 4px solid #ffffff;
            color: #ffffff;
            font-weight: 700;
        }
        
        /* Tailwind/Bootstrap Conflict Fixes */
        a { text-decoration: none; }
        
        /* --- DASHBOARD SCOPED CSS --- */
        /* We scope everything under .dashboard-wrapper to prevent global leaks */
        
        :root {
            --bg-color: #f8fafc;
            --sidebar-bg: #0f172a;
            --text-main: #334155;
            --col-primary: #0f766e; /* Teal 700 (Kept for UI accents) */
            
            /* UI Accents (Text colors from Blue/Green palette) */
            --text-race-cat: #1f78b4; /* Dark Blue */
            --text-ethnic-grp: #33a02c; /* Dark Green */
            
            --col-success: #10b981;
            --col-warning: #f59e0b;
            --col-danger: #f43f5e;
            --col-info: #3b82f6;
            
            --card-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --card-hover: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* The Container */
        .dashboard-wrapper {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex; /* Flex layout ONLY for dashboard area */
            min-height: 800px;
            width: 100%;
            position: relative;
        }

        /* Custom Select for Header */
        .header-select {
            background-color: white; border: 1px solid #cbd5e1;
            color: #334155; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem;
            cursor: pointer; transition: all 0.2s; min-width: 200px;
            font-weight: 500;
        }
        .header-select:hover { border-color: #94a3b8; }
        .header-select:focus { outline: none; border-color: var(--col-primary); box-shadow: 0 0 0 2px rgba(15, 118, 110, 0.1); }

        /* Main Dashboard Area */
        .dashboard-content {
            flex-grow: 1;
            padding: 40px;
            padding-top: 0; /* Removing top padding because header handles spacing */
            width: 100%;
            background-color: var(--bg-color);
        }

        /* STICKY HEADER CONFIGURATION */
        .dashboard-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center; /* Centered items for single line feel */
            margin-bottom: 30px;
            border-bottom: 1px solid #e2e8f0; 
            padding-bottom: 20px;
            
            /* Sticky Magic */
            position: sticky;
            top: 128px; /* Height of the main Teal Nav (h-32 = 128px) */
            z-index: 40;
            background-color: var(--bg-color); /* Opaque background needed for sticky */
            padding-top: 40px; /* Add padding here instead of container to look good when stuck */
            flex-wrap: wrap; /* Added wrapping for responsiveness */
            gap: 20px;
        }

        /* Mobile Sticky Adjustment */
        @media (max-width: 768px) {
            .dashboard-header {
                top: 80px; /* Approximate mobile header height */
                padding-top: 20px;
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }

        /* Title Styling - Single Line Force */
        .dashboard-title {
            display: flex;
            align-items: baseline;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .dashboard-title h1 {
            font-size: 2.2rem; font-weight: 800; letter-spacing: -1px; margin: 0; color: #0f172a;
            white-space: nowrap;
        }

        .active-filter {
            color: var(--col-primary); font-weight: 700; background: #eef2ff;
            padding: 4px 12px; border-radius: 99px; font-size: 0.95rem;
        }

        .header-controls {
            display: flex; align-items: center; gap: 0; /* Removing gap, using margins in elements to control joins */
        }

        .btn-action {
            padding: 9px 16px; border: 1px solid #e2e8f0; background: white;
            border-radius: 8px; font-weight: 600; color: #475569; cursor: pointer;
            transition: all 0.2s; box-shadow: var(--card-shadow);
            display: flex; align-items: center; gap: 8px;
            margin-left: 12px;
        }
        .btn-action:hover { transform: translateY(-1px); box-shadow: var(--card-hover); color: var(--col-primary); }

        /* KPI Cards */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;
        }

        .kpi-card {
            background: white; padding: 24px 30px; border-radius: 16px;
            box-shadow: var(--card-shadow); display: flex; align-items: center;
            justify-content: space-between; height: 140px; transition: all 0.3s ease;
            position: relative; overflow: hidden; border: 1px solid #f1f5f9;
        }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: var(--card-hover); }
        
        .kpi-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: currentColor;
        }

        /* KPI Colors mapped to new palette */
        .kpi-card.primary { color: #1f78b4; } /* Dark Blue */
        .kpi-card.green { color: var(--col-success); }
        .kpi-card.yellow { color: var(--col-warning); }
        .kpi-card.red { color: var(--col-danger); }
        .kpi-card.blue { color: #33a02c; } /* Dark Green */
        .kpi-card.dark { color: #475569; }

        .kpi-content { display: flex; flex-direction: column; justify-content: center; }
        .kpi-label { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: #1e293b; line-height: 1; }
        .kpi-icon { font-size: 2.5rem; color: currentColor; opacity: 0.8; }

        /* Charts */
        .section-card {
            background: white; border-radius: 16px; box-shadow: var(--card-shadow);
            padding: 24px; margin-bottom: 24px; border: 1px solid #f1f5f9;
        }

        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px; padding-bottom: 15px; border-bottom: 1px solid #f8fafc;
        }

        /* Modified to allow column layout for title + description */
        .section-header-content {
            display: flex; flex-direction: column;
        }

        .section-title {
            font-size: 1.1rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 12px;
        }
        
        .section-icon { color: var(--col-primary); font-size: 1.25rem; }

        .chart-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px; }
        
        /* Updated chart-container for uniform height */
        .chart-container { position: relative; height: 320px; width: 100%; }
        
        /* Adjusted height for category charts to fit multiple in view better */
        .chart-container-category { position: relative; height: 380px; width: 100%; }
        
        /* TALL CHART CONTAINER FOR GROUPED CHARTS - Increased by ~25% from 550px to 690px */
        .chart-container-tall { position: relative; height: 690px; width: 100%; }

        /* Comparison View */
        .detailed-header-row {
            display: flex; padding: 12px 20px; background: #f8fafc; border-radius: 8px;
            margin-bottom: 12px; font-size: 0.75rem; color: #64748b; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid #e2e8f0;
        }

        .detailed-row {
            display: flex; align-items: center; padding: 14px 20px;
            border-bottom: 1px solid #f1f5f9; transition: all 0.2s; font-size: 0.9rem; 
        }
        .detailed-row:last-child { border-bottom: none; }
        .detailed-row:hover { background: #f8fafc; }

        .col-metric { width: 22%; font-weight: 600; color: #334155; }
        .col-value { width: 14%; font-weight: 700; color: #0f172a; } 
        .col-ref-1 { width: 14%; color: #64748b; text-align: right; padding-right: 15px; border-left: 1px solid #f1f5f9; }
        .col-stat-1 { width: 18%; text-align: right; padding-right: 10px; }
        .col-ref-2 { width: 14%; color: #64748b; text-align: right; padding-right: 15px; border-left: 1px solid #f1f5f9; }
        .col-stat-2 { width: 18%; text-align: right; }

        .status-badge { display: inline-flex; align-items: center; justify-content: flex-end; gap: 4px; padding: 2px 0; font-weight: 600; }
        .text-green { color: var(--col-success); }
        .text-red { color: var(--col-danger); }
        .text-gray { color: #94a3b8; }

        /* Data Table Styles (UPDATED) */
        .data-table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 600px; }
        .data-table { width: max-content; /* Ensure table expands for horizontal scroll */ min-width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        
        .data-table th {
            text-align: left; padding: 12px 10px; background: #f8fafc; color: #475569;
            font-weight: 700; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; 
            white-space: normal; /* Allow text wrapping */
            vertical-align: bottom;
            line-height: 1.3;
        }

        /* Sticky First Column ("Group") - WIDENED for long names */
        .data-table th:first-child, .data-table td:first-child {
            position: sticky; left: 0; z-index: 20;
            background-color: #f8fafc; /* Match header bg */
            border-right: 2px solid #e2e8f0;
            text-align: left !important;
            width: 260px; min-width: 260px; max-width: 260px; /* Increased from 180px */
        }
        .data-table td:first-child { background-color: white; } /* Body bg */
        .data-table tr:hover td:first-child { background-color: #f1f5f9; } /* Hover bg */

        /* Uniform Columns for Data - EVEN SPACING */
        .data-table th:not(:first-child), .data-table td:not(:first-child) {
            width: 110px; min-width: 110px; max-width: 110px;
            text-align: center;
        }

        .data-table td { padding: 10px 10px; border-bottom: 1px solid #f1f5f9; color: #334155; white-space: nowrap; }
        .data-table tr:hover td { background-color: #f1f5f9; cursor: pointer; color: #1f78b4; }

        .row-total-pop td { background-color: #fef2f2 !important; font-weight: 700; border-bottom: 2px solid #fee2e2; } /* Reddish tint for Total Pop */
        
        /* Race Categories (White, Black, Asian) */
        .row-race-cat td:first-child { color: var(--text-race-cat) !important; font-weight: 600; } 
        
        /* Specific Ethnic Groups (Bangladeshi -> Vietnamese) */
        .row-ethnic-grp td:first-child { color: var(--text-ethnic-grp) !important; font-weight: 500; }

        /* Responsive */
        @media (max-width: 1100px) {
            .chart-grid, .kpi-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .dashboard-content { padding: 20px; }
            .header-controls { width: 100%; justify-content: space-between; flex-wrap: wrap; }
            .header-select { flex-grow: 1; }
            .detailed-header-row { display: none; }
            .detailed-row { flex-wrap: wrap; }
            .col-metric { width: 100%; margin-bottom: 5px; }
            .col-value, .col-ref-1, .col-stat-1, .col-ref-2, .col-stat-2 { width: 50%; border: none; text-align: left; }
        }
        
        /* Visibility Helpers */
        .hidden { display: none !important; }

        /* --- PRINT OPTIMIZATIONS --- */
        @media print {
            @page { margin: 0.5cm; size: landscape; }
            *, *::before, *::after {
                background: transparent !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            body {
                margin: 0; padding: 0;
                background-color: #fff !important;
                font-size: 12pt; line-height: 1.5;
                overflow: visible !important;
            }
            /* Hide Navigation & Buttons */
            nav, footer, .header-controls button, .btn-action, .tab-btn { display: none !important; }
            
            /* Layout & Content */
            .dashboard-wrapper, .dashboard-content {
                display: block !important; width: 100% !important; height: auto !important;
                overflow: visible !important; padding: 0 !important; margin: 0 !important;
            }
            .dashboard-header {
                position: static !important; padding-top: 0 !important;
                border-bottom: 2px solid #333; margin-bottom: 20px;
                display: flex !important; flex-direction: row !important; justify-content: space-between !important;
            }
            .header-controls { display: block !important; }
            .header-controls select { border: none !important; appearance: none !important; font-weight: bold; background: none !important; padding: 0; }
            
            /* KPI Grid */
            .kpi-grid {
                display: grid !important; grid-template-columns: repeat(3, 1fr) !important;
                gap: 15px !important; margin-bottom: 20px !important; page-break-inside: avoid;
            }
            .kpi-card {
                height: auto !important; min-height: 80px;
                border: 1px solid #ccc !important; padding: 10px !important;
                box-shadow: none !important; page-break-inside: avoid;
            }
            .kpi-value { font-size: 1.6rem !important; }
            .kpi-icon { display: none !important; }

            /* Charts */
            .chart-grid { display: block !important; }
            .section-card {
                border: 1px solid #ccc !important; margin-bottom: 20px !important;
                page-break-inside: avoid; break-inside: avoid; box-shadow: none !important;
            }
            .chart-container, .chart-container-small, .chart-container-category {
                height: 300px !important; width: 100% !important;
            }
            .chart-container-tall { height: 500px !important; }

            /* Tables */
            .data-table-container { overflow: visible !important; max-height: none !important; border: none !important; }
            .data-table { font-size: 9px !important; width: 100% !important; }
            .data-table th, .data-table td { padding: 4px !important; border: 1px solid #ddd !important; }
            .section-header .text-xs { display: none !important; } /* Hide scroll hint */

            /* Visibility Logic */
            .hidden { display: none !important; }
            #group-view-container:not(.hidden), #category-view-container:not(.hidden) { display: block !important; }
            
            -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <!-- Broader Teal Banner / Header (Retained Teal as requested) -->
    <nav class="bg-teal-700 shadow-md border-b border-teal-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col md:flex-row justify-between items-center h-auto md:h-32 py-4 md:py-0">
                
                <!-- Logo / Title Section -->
                <div class="flex items-end mb-4 md:mb-0">
                    <i class="fa-solid fa-chart-pie text-white text-5xl mr-4 pb-1"></i>
                    <div class="flex flex-col justify-end">
                        <span class="font-bold text-2xl md:text-3xl tracking-tight text-white leading-none mb-1">Montgomery County</span>
                        <span class="font-medium text-teal-100 text-lg uppercase tracking-wide leading-none">AAPI Community Explorer</span>
                    </div>
                </div>

                <!-- Tab Buttons -->
                <div class="flex space-x-1 md:space-x-8 h-12 md:h-full items-end w-full md:w-auto justify-center md:justify-end">
                    <button onclick="switchTab('intro')" id="btn-intro" class="tab-btn active inline-flex items-center px-4 py-3 text-sm md:text-base font-medium h-16 bg-transparent border-0">
                        Introduction
                    </button>
                    <button onclick="switchTab('dictionary')" id="btn-dictionary" class="tab-btn inline-flex items-center px-4 py-3 text-sm md:text-base font-medium h-16 bg-transparent border-0">
                        Data Dictionary
                    </button>
                    <button onclick="switchTab('explorer')" id="btn-explorer" class="tab-btn inline-flex items-center px-4 py-3 text-sm md:text-base font-medium h-16 bg-transparent border-0">
                        Dashboard
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- TAB 1: INTRODUCTION -->
        <div id="tab-intro" class="tab-content block animate-fade-in">
            <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                <div class="p-8 border-b border-slate-200">
                    <!-- About the Project -->
                    <div class="mb-10 border-b border-slate-200 pb-8">
                        <h2 class="text-3xl font-bold text-teal-800 mb-4">About the Project</h2>
                        
                        <div class="grid md:grid-cols-3 gap-8 items-start">
                            <div class="md:col-span-3">
                                <p class="text-md text-slate-600 mb-4 leading-relaxed">
                                    This dashboard is created as part of the report developed to Understand the Asian American Diversity & Growth in Montgomery County.
                                </p>
                                <p class="text-md text-slate-600 mb-4 leading-relaxed">
                                    Commissioned by the <strong>Asian American Coalition for Health and Wellness</strong>, this project received funding from Montgomery County’s Office of Recovery and fiscal and administrative support from HealthSpark Foundation. Consultants Sojourner Consulting and Solutions International designed and carried out the study.
                                </p>
                                <p class="text-md text-slate-600 mb-6 leading-relaxed">
                                    The study involved a literature review, interviews, focus groups, and demographic analysis to understand the community better. It aimed to build community engagement, highlight local leadership, and provide a foundation for future initiatives.
                                </p>
                            
                            <div class="text-center">
                                <a href="https://drive.google.com/file/d/1I0t3GdtKDLcI_Lk0B2u0Nkzv06EmkABc/view?usp=sharing" target="_blank" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-teal-700 hover:bg-teal-800 transition-colors mb-6">
                                    <i class="fa-solid fa-file-lines mr-2"></i> Link to the Report
                                </a>

                                <div class="p-1 rounded-lg shadow-sm flex justify-start items-center">
                                    <img src="https://lh3.googleusercontent.com/d/19F1JfQC4XcyfzBy0gnkuf2NhHX5nr75e" alt="Project Stakeholders and Partners" class="max-w-full h-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                                    <div class="hidden text-center text-slate-400 p-4">
                                        <i class="fa-solid fa-image text-4xl mb-2"></i>
                                        <p class="text-sm">Stakeholder image not found.<br>Ensure "image_356d3f.png" is in the folder.</p>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- Welcome Section -->
                    <h1 class="text-2xl font-bold text-teal-800 mb-4">Welcome to the Dashboard</h1>
                    <p class="text-lg text-slate-600 mb-6 leading-relaxed">
                        The <strong>Montgomery County AAPI Community Explorer</strong> was created to make critical demographic and socioeconomic data publicly accessible to community leaders, policymakers, and residents. By democratizing this data, we aim to foster a deeper understanding of the diverse Asian American and Pacific Islander (AAPI) communities within Montgomery County, enabling data-driven advocacy and resource allocation.
                    </p>
                    
                    <h2 class="text-2xl font-semibold text-slate-800 mb-4">Directions to Use This Dashboard</h2>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <h3 class="text-lg font-bold text-teal-700 mb-3"><i class="fa-solid fa-layer-group mr-2"></i>1. Explore Available Data</h3>
                            <p class="text-slate-600 mb-4">You can explore a wide range of indicators across the following categories:</p>
                            <ul class="list-disc pl-5 space-y-2 text-slate-700 text-sm">
                                <li><strong>Demographics:</strong> Population counts, foreign-born status, and household size.</li>
                                <li><strong>Economic Indicators:</strong> Median household income, poverty status, and SNAP usage.</li>
                                <li><strong>Employment:</strong> Labor force participation and unemployment rates.</li>
                                <li><strong>Housing:</strong> Homeownership, housing values, and rent burden.</li>
                                <li><strong>Social Wellbeing:</strong> Health insurance coverage and English proficiency (LEP).</li>
                            </ul>
                        </div>

                        <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-shadow">
                            <h3 class="text-lg font-bold text-teal-700 mb-3"><i class="fa-solid fa-filter mr-2"></i>2. Filter, Analyze & Export</h3>
                            <p class="text-slate-600 mb-4">Navigate to the <strong>"Dashboard"</strong> tab to interact with the data:</p>
                            <ol class="list-decimal pl-5 space-y-3 text-slate-700 text-sm">
                                <li><strong>Filter By:</strong> Toggle between viewing by "Race/Ethnic Group" or comparing a single "Category" across all groups.</li>
                                <li><strong>Select a Group/Category:</strong> Use the dropdown to visualize the specific data point or group you are interested in.</li>
                                <li><strong>Export Data:</strong> Click the "Export Data" button to download the filtered dataset as a CSV file.</li>
                            </ol>
                            <!-- Moved Description Below 3. Export Data as requested -->
                            <div class="text-slate-500 italic mt-4 font-medium bg-slate-100 p-3 rounded border border-slate-200 text-sm">
                                <i class="fa-solid fa-info-circle text-teal-600 mr-1"></i> The <strong>Race/Ethnic Group</strong> filter focuses on one community's complete profile, while the <strong>Category Comparison</strong> filter compares specific topics (like Housing) across all communities.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: DATA DICTIONARY -->
        <div id="tab-dictionary" class="tab-content hidden animate-fade-in">
            <div class="bg-white shadow-sm sm:rounded-lg overflow-hidden">
                <div class="px-6 py-5 border-b border-slate-200 bg-slate-50 flex justify-between items-start">
                    <div class="max-w-4xl">
                        <!-- Increased Header to 3xl to match Intro -->
                        <h2 class="text-3xl font-bold text-slate-900">Data Dictionary</h2>
                        <!-- Increased body text to base (16px) -->
                        <p class="mt-2 text-base text-slate-500">This section contains definitions and detailed sources for all variables used in this dashboard.</p>
                        <p class="mt-3 text-base text-slate-600 leading-relaxed">
                            Demographic data offers a statistical view of a population's characteristics. Disaggregated data is vital because it breaks down broad, summarized categories (like "Asian American") into specific subgroups (such as Vietnamese, Korean, or Indian) to uncover distinct characteristics and trends. Its importance lies in revealing disparities and needs that aggregated averages often hide, enabling policymakers to direct resources and support more equitably to the communities that actually need them.
                        </p>
                    </div>
                    <button onclick="window.print()" class="text-slate-500 hover:text-teal-700 transition ml-4 mt-1" title="Print Data Dictionary">
                        <i class="fa-solid fa-print text-2xl"></i>
                    </button>
                </div>
                
                <!-- Increased bottom padding from pb-2 to pb-10 for more space before table -->
                <div class="px-6 pt-6 pb-10">
                    <!-- Terminology and Methodology Section -->
                    <div class="mb-6">
                        <!-- Increased Subheader to 2xl -->
                        <h3 class="text-2xl font-bold text-teal-800 mb-3">Terminology and Methods</h3>
                        <!-- Increased content text to base -->
                        <div class="bg-slate-50 p-6 rounded-md border border-slate-200 text-base text-slate-700">
                            <p class="mb-2">The following terms and methods are used throughout the report:</p>
                            <ul class="list-disc pl-5 space-y-2">
                                <li>“Asian” or “Asian Americans” are both used to refer to the Asian racial group, regardless of citizenship status.</li>
                                <li>“Ethnic group” is used to refer to Asian sub-groups or Asian national origin groups.</li>
                                <li>Individuals who identify as Taiwanese are measured under the “Taiwanese,” not “Chinese,” category.</li>
                                <li>Unless otherwise indicated, Census data for racial groups include both “race alone” and “in combination with other races”.</li>
                                <li>Individuals who identify as Hispanic or Latino are referred to as an ethnic and not a racial group, as defined by the Census Bureau (i.e. Asian and Hispanic population data may overlap).</li>
                                <li>Datasets with high margins of error are not included here, as they are associated with higher uncertainty, although all datasets are included in the Appendices.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Data Source Section -->
                    <div class="bg-teal-50 border-l-4 border-teal-600 p-6 rounded-r-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fa-solid fa-database text-teal-600 text-2xl"></i>
                            </div>
                            <div class="ml-4">
                                <!-- Increased Subheader to 2xl -->
                                <h3 class="text-2xl font-bold text-teal-800">Data Source</h3>
                                <!-- Increased content text to base -->
                                <p class="text-base text-teal-900 mt-2">
                                    Demographic data was primarily sourced from the U.S. Census Bureau’s American Community Survey (2017-21) and Decennial Census (2010 and 2020). At the time of publication, these were the most recent data sources which provide racially disaggregated data to the extent they were available.
                                </p>
                                <p class="text-base text-teal-900 mt-2 italic">
                                    * Based on rapid growth trends and observations of community leaders and elected officials, population data in this report is likely to be lower than actual population size.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <!-- Increased Table Header Text size -->
                                <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-slate-500 uppercase tracking-wider w-1/4">Variable Name</th>
                                <th scope="col" class="px-6 py-4 text-left text-sm font-bold text-slate-500 uppercase tracking-wider w-1/3">Description</th>
                            </tr>
                        </thead>
                        <!-- Increased Table Body Text size to base (16px) -->
                        <tbody class="bg-white divide-y divide-slate-200 text-base">
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Ethnicity</td><td class="px-6 py-4 text-slate-600">The specific racial or ethnic group (e.g., Asian Indian, Chinese, Filipino) represented.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Population</td><td class="px-6 py-4 text-slate-600">Total number of people in the specified group.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Population Growth Rate</td><td class="px-6 py-4 text-slate-600">Percentage change in population size over 2010 and 2020 calculated using DEC data.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Median Age</td><td class="px-6 py-4 text-slate-600">The age that divides the population into two numerically equal groups.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Sex Ratio</td><td class="px-6 py-4 text-slate-600">Number of males per 100 females.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Foreign Born Population</td><td class="px-6 py-4 text-slate-600">People who were not U.S. citizens at birth.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Average Household Size</td><td class="px-6 py-4 text-slate-600">Average number of people living in a housing unit.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Median Income</td><td class="px-6 py-4 text-slate-600">Income amount dividing the income distribution into two equal groups (dollars).</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Per Capita Income</td><td class="px-6 py-4 text-slate-600">Mean income computed for every man, woman, and child in the group (dollars).</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Poverty Rate</td><td class="px-6 py-4 text-slate-600">Percentage of people whose income falls below the federal poverty threshold. Includes specific data for seniors (65+).</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Population with SNAP Benefits</td><td class="px-6 py-4 text-slate-600">Percentage of households receiving Food Stamps/SNAP benefits in past 12 months.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Labor Force Participation</td><td class="px-6 py-4 text-slate-600">Percentage of population aged 16+ currently employed or seeking work.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Unemployment Rate</td><td class="px-6 py-4 text-slate-600">Percentage of the civilian labor force that is unemployed and actively looking.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Housing Tenure</td><td class="px-6 py-4 text-slate-600">Distinguishes between Owner-occupied and Renter-occupied housing units.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Mortgage Housing Cost Burden</td><td class="px-6 py-4 text-slate-600">Percentage of homeowners with a mortgage paying 30% or more of income on housing costs.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Median Gross Rent</td><td class="px-6 py-4 text-slate-600">Median contract rent plus estimated average monthly cost of utilities (dollars).</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Rent Burden</td><td class="px-6 py-4 text-slate-600">Percentage of renting households paying more than 30% of gross income on rent.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Limited English Proficiency (LEP)</td><td class="px-6 py-4 text-slate-600">Percentage of population speaking English less than "very well". Includes breakdowns by age groups (5-17, 18-64, 65+).</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Language Diversity</td><td class="px-6 py-4 text-slate-600">Percentage of population (5 years and over) that speaks a language other than English at home.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Educational Attainment</td><td class="px-6 py-4 text-slate-600">Percentage of population (25 years and over) with at least a high school diploma or a bachelor's degree or higher.</td></tr>
                            <tr class="hover:bg-slate-50 transition"><td class="px-6 py-4 font-bold text-slate-800">Population without Health Insurance</td><td class="px-6 py-4 text-slate-600">Percentage of civilian noninstitutionalized population without health insurance coverage.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 3: DASHBOARD -->
        <div id="tab-explorer" class="tab-content hidden animate-fade-in dashboard-wrapper">
            
            <!-- DASHBOARD MAIN CONTENT -->
            <div class="dashboard-content">
                
                <!-- Sticky Dashboard Header -->
                <div class="dashboard-header">
                    <div class="dashboard-title">
                        <h1>Community Dashboard</h1>
                        <span class="text-slate-400 text-xl font-light mx-2">|</span>
                        <div style="color: #64748b; font-weight: 500; display: flex; align-items: center;">
                            Viewing: <span class="active-filter ms-2" id="activeGroup">-</span>
                        </div>
                    </div>

                    <!-- Header Controls -->
                    <div class="header-controls">
                        <div class="d-flex align-items-center">
                            <span class="text-xs text-slate-400 uppercase font-bold me-2">Filter By:</span>
                            <select id="filterMode" class="header-select" style="min-width: 160px; border-right: none; border-top-right-radius: 0; border-bottom-right-radius: 0;">
                                <option value="group" selected>Race/Ethnic Group</option>
                                <option value="category">Category Comparison</option>
                            </select>
                        </div>
                        <div class="d-flex align-items-center">
                            <select id="primaryFilter" class="header-select" style="border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: 1px solid #f1f5f9;">
                                <option value="">Awaiting Data...</option>
                            </select>
                        </div>
                        <button onclick="window.print()" class="btn-action" title="Print Dashboard">
                            <i class="fas fa-print"></i> <span>Print Report</span>
                        </button>
                    </div>
                </div>

                <!-- === VIEW 1: GROUP DASHBOARD (Standard View) === -->
                <div id="group-view-container">
                    <!-- KPI GRID -->
                    <div class="kpi-grid">
                        <div class="kpi-card primary">
                            <div class="kpi-content">
                                <div class="kpi-label">Total Population</div>
                                <div class="kpi-value" id="val-pop">-</div>
                            </div>
                            <div class="kpi-icon"><i class="fas fa-user-group"></i></div>
                        </div>
                        <!-- Changed: Median Gross Rent -> Population Growth Rate -->
                        <div class="kpi-card blue">
                            <div class="kpi-content">
                                <div class="kpi-label">Population Growth Rate (between 2010 and 2020)</div>
                                <div class="kpi-value" id="val-growth">-</div>
                            </div>
                            <div class="kpi-icon"><i class="fas fa-arrow-trend-up"></i></div>
                        </div>
                        <div class="kpi-card green">
                            <div class="kpi-content">
                                <div class="kpi-label">Median Income</div>
                                <div class="kpi-value" id="val-income">-</div>
                            </div>
                            <div class="kpi-icon"><i class="fas fa-wallet"></i></div>
                        </div>
                        <!-- Reordered: Unemployment to 4th -->
                        <div class="kpi-card yellow">
                            <div class="kpi-content">
                                <div class="kpi-label">Unemployment Rate</div>
                                <div class="kpi-value" id="val-unemployment">-</div>
                            </div>
                            <div class="kpi-icon"><i class="fas fa-briefcase"></i></div>
                        </div>
                        <div class="kpi-card dark">
                            <div class="kpi-content">
                                <div class="kpi-label">Avg Household Size</div>
                                <div class="kpi-value" id="val-hh-size">-</div>
                            </div>
                            <div class="kpi-icon"><i class="fas fa-home"></i></div>
                        </div>
                        <div class="kpi-card red">
                            <div class="kpi-content">
                                <div class="kpi-label">Total LEP Rate</div>
                                <div class="kpi-value" id="val-lep">-</div>
                            </div>
                            <div class="kpi-icon"><i class="fas fa-language"></i></div>
                        </div>
                    </div>

                    <!-- CHARTS SECTION 1 -->
                    <div class="chart-grid">
                        <div class="section-card">
                            <div class="section-header">
                                <div class="section-title">Employment Distribution</div>
                            </div>
                            <div class="chart-container"><canvas id="employmentChart"></canvas></div>
                        </div>
                        <div class="section-card">
                            <div class="section-header">
                                <div class="section-title">Economic Indicators</div>
                            </div>
                            <div class="chart-container"><canvas id="economicChart"></canvas></div>
                        </div>
                    </div>

                    <!-- CHARTS SECTION 2 -->
                    <div class="chart-grid">
                        <div class="section-card">
                            <div class="section-header">
                                <div class="section-title">Housing Tenure</div>
                            </div>
                            <div class="chart-container"><canvas id="housingChart"></canvas></div>
                        </div>
                        <div class="section-card">
                            <div class="section-header">
                                <div class="section-title">Limited English Proficiency (LEP) by Age Group</div>
                            </div>
                            <div class="chart-container"><canvas id="lepChart"></canvas></div>
                        </div>
                    </div>

                    <!-- QUICK COMPARISON VIEW -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-header-content">
                                <div class="section-title">Quick Comparison View</div>
                                <p class="text-sm text-slate-500 mt-1">Compare key metrics of the selected group against the Total Population and Asian Population averages.</p>
                            </div>
                        </div>
                        <div class="detailed-header-row">
                            <div class="col-metric">Variable</div>
                            <div class="col-value">Value</div>
                            <div class="col-ref-1" id="detailedRefHeader1">Ref (Total)</div>
                            <div class="col-stat-1">Vs Total</div>
                            <div class="col-ref-2">Asian</div>
                            <div class="col-stat-2">Vs Asian</div>
                        </div>
                        <div id="detailedViewContainer">
                            <div style="padding: 30px; text-align: center; color: #94a3b8; font-style: italic;">
                                <i class="fas fa-spinner fa-spin me-2"></i> Loading data from GitHub...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === VIEW 2: CATEGORY COMPARISON VIEW === -->
                <div id="category-view-container" class="hidden">
                    <div id="categoryChartsGrid" class="chart-grid">
                        <!-- Dynamic Charts Injected Here -->
                    </div>
                </div>

                <!-- DETAILED DATA TABLE -->
                <div class="section-card">
                    <div class="section-header">
                        <div class="section-header-content">
                            <div class="section-title">Detailed Data Table</div>
                            <p id="dataTableDesc" class="text-sm text-slate-500 mt-1">This table displays a comprehensive breakdown of all available metrics for every racial and ethnic group.</p>
                        </div>
                        <div class="text-xs text-slate-400 italic font-medium mt-2"><i class="fa-solid fa-arrows-left-right mr-1"></i> Scroll horizontally for more data</div>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead id="tableHeader"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-slate-200 mt-auto py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-slate-500 text-sm">
                &copy; 2025 Montgomery County AAPI Community Explorer. Data provided by U.S. Census Bureau ACS 5-Year Estimates.
            </p>
        </div>
    </footer>

    <script>
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.getElementById('btn-' + tabName).classList.add('active');
        }

        Chart.register(ChartDataLabels);

        let rawData = [];
        let referenceData = null; 
        let asianData = null;     
        let charts = { housing: null, employment: null, economic: null, lep: null, categoryCharts: [] };

        const PALETTE = {
            lightBlue: '#a6cee3',
            darkBlue: '#1f78b4',
            lightGreen: '#b2df8a',
            darkGreen: '#33a02c',
            totalPop: '#ca0020'
        };

        const DATA_LABEL_FONT_SIZE = 14;

        // Updated Variable Categories per user request
        const VARIABLE_CATEGORIES = {
            "Demographics": [
                { id: "pop", label: "Population" },
                { id: "growthRate", label: "Population Growth Rate (%)" },
                { id: "medianAge", label: "Median Age" },
                { id: "sexRatio", label: "Sex Ratio" },
                { id: "foreignBorn", label: "Foreign Born Population" },
                { id: "hhSize", label: "Average Household Size" }
            ],
            "Economic Indicators": [
                { id: "medInc", label: "Median Income ($)" },
                { id: "perCap", label: "Per Capita Income ($)" },
                { id: "povertyRate", label: "Percentage Below Poverty Level (%)" },
                { id: "povertySenior", label: "Senior Poverty Rate (%)" }
            ],
            "Housing": [
                { id: "own", label: "Homeownership Rate (%)" },
                { id: "costBurden", label: "Mortgage Housing Cost Burden (%)" },
                { id: "grossRent", label: "Median Gross Rent ($)" },
                { id: "burden", label: "Rent Burden (%)" }
            ],
            "Social Wellbeing": [
                { id: "lep", label: "Percentage of English Language Learners (%)" },
                { id: "langDiv", label: "Language Diversity (%)" },
                {
                    id: "lepGrouped",
                    label: "Percent English Language Learner for Children (5 to 17 yrs) and Seniors (Above 65 yrs)",
                    grouped: true,
                    subMetrics: [
                        { id: "lep5_17", label: "LEP 5-17 Years" },
                        { id: "lep65", label: "LEP 65+ Years" }
                    ]
                },
                {
                    id: "education",
                    label: "Educational Attainment (%)",
                    grouped: true,
                    subMetrics: [
                        { id: "eduHighSchool", label: "High School+" },
                        { id: "eduBachelor", label: "Bachelor+" }
                    ]
                },
                { id: "snap", label: "Population with SNAP Benefits (%)" },
                { id: "healthIns", label: "Population without Health Insurance (%)" }
            ],
            "Employment": [
                { id: "laborForce", label: "Labor Force Participation (%)" },
                { id: "unemp", label: "Unemployment Rate (%)" }
            ]
        };

        const parseNum = (str) => {
            if (str == null || str === '') return 0;
            if (typeof str === 'number') return str;
            if (typeof str === 'string' && (str.trim() === '-' || str.trim().toLowerCase() === 'n/a')) return 0;
            let clean = (str + '').replace(/["'\s,%$\ufeff]/g, ''); 
            return parseFloat(clean) || 0;
        };
        const cleanStr = (str) => (str || "").replace(/['"]+/g, '').trim();
        const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
        const formatNumber = (num) => new Intl.NumberFormat('en-US').format(num);

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = '#f1f5f9';

        document.addEventListener("DOMContentLoaded", () => {
            const filterMode = document.getElementById('filterMode');
            const primaryFilter = document.getElementById('primaryFilter');
            filterMode.addEventListener('change', () => {
                populatePrimaryFilter();
                updateDashboard();
            });
            primaryFilter.addEventListener('change', () => {
                updateDashboard();
            });
            loadDefaultData();
        });

        async function loadDefaultData() {
            const dataUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRH2cvOOQf5HuOMrPUOh6em9YK7EmyvB14O4Kx4pUnfG9X2wLIaXQG54lQzU6to5jXW7376PbxE8s-j/pub?gid=930484769&single=true&output=csv";
            const activeGroup = document.getElementById("activeGroup");
            if(activeGroup) activeGroup.textContent = "Loading Data...";

            try {
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error(`Fetch Error: ${response.status}`);
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true, skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            processParsedData(results.data);
                        } else {
                            if(activeGroup) activeGroup.innerHTML = `<span class="text-red-600">Error: Empty Data</span>`;
                        }
                    },
                    error: function(err) { throw new Error(`CSV Parse Error: ${err.message}`); }
                });
            } catch (err) {
                console.error("Error loading data:", err);
                if(activeGroup) activeGroup.innerHTML = `<span class="text-red-600">Error Loading Data</span>`;
            }
        }

        function processParsedData(data) {
            rawData = []; referenceData = null; asianData = null;
            data.forEach(row => {
                if (!row["Ethnicity"]) return;
                try {
                    let bplRate = parseNum(row["BPL - All people"]);
                    let population = parseNum(row["Population"]); 
                    
                    let mapped = {
                        group: cleanStr(row["Ethnicity"]),
                        pop: population,
                        growthRate: parseNum(row["Population Growth Rate"]),
                        medianAge: parseNum(row["Median Age"]),
                        sexRatio: parseNum(row["Sex Ratio"]),
                        
                        // Economic
                        medInc: parseNum(row["Median household income (dollars)"]),
                        perCap: parseNum(row["Per capita income (dollars)"]),
                        povertyRate: bplRate,
                        povertySenior: parseNum(row["BPL - Seniors"]), // Sourced from new column
                        snap: parseNum(row["SNAP %"]),
                        
                        // Housing
                        own: parseNum(row["% Owner-Occupied"]),
                        // Handle potential typo "Hosuing" or correct "Housing"
                        costBurden: parseNum(row["Housing Cost Burden (Mortgage)"] || row["Hosuing Cost Burden (Mortgage)"]),
                        grossRent: parseNum(row["Gross Rent - Median (dollars)"]),
                        burden: parseNum(row["% Rent Burdened"]),
                        housingValue: parseNum(row["Housing Value - Median (dollars)"]),
                        rent: parseNum(row["% Renter-Occupied"]),

                        // Social / Education
                        lep: parseNum(row["Total % of LEP"]),
                        eduHighSchool: parseNum(row["% of High school graduate or higher"]),
                        eduBachelor: parseNum(row["% of Bachelor's degree or higher"]),
                        langDiv: parseNum(row["Language Other than English"]),
                        healthIns: parseNum(row["Health Ins. - No health insurance coverage"]),
                        
                        // Other existing
                        laborForce: parseNum(row["Percentage In labor force"]), 
                        unemp: parseNum(row["Unemployment Rate"]),
                        priv: parseNum(row["Private wage and salary workers"]),
                        gov: parseNum(row["Government workers"]),
                        self: parseNum(row["Self-employed in own not incorporated business workers"]),
                        unpaid: parseNum(row["Unpaid family workers"]),
                        foreignBorn: parseNum(row["Foreign-born population"]), 
                        hhSize: parseNum(row["Average household size"]),
                        lep5_17: parseNum(row["% of LEP 5 to 17 years"]),
                        lep18_64: parseNum(row["% of LEP 18 to 64 years"]),
                        lep65: parseNum(row["% of LEP 65 years and over"])
                    };
                    rawData.push(mapped);
                } catch (err) { console.error("Error mapping row:", err); }
            });
            const totalPopRow = rawData.find(d => d.group.toLowerCase().includes("total population"));
            const asianRow = rawData.find(d => d.group.toLowerCase() === "asian" || d.group.toLowerCase() === "asian alone");
            referenceData = totalPopRow || rawData[0];
            asianData = asianRow || rawData[0]; 
            if (rawData.length > 0) {
                populatePrimaryFilter(); populateDataTable(); updateDashboard();
            }
        }

        function populatePrimaryFilter() {
            const mode = document.getElementById('filterMode').value;
            const selector = document.getElementById("primaryFilter");
            selector.innerHTML = '';
            if (mode === 'group') {
                rawData.forEach(item => {
                    const option = document.createElement("option"); option.value = item.group; option.text = item.group; selector.appendChild(option);
                });
                if(rawData.length > 1 && rawData[0].group.toLowerCase().includes("total")) selector.value = rawData[1].group; 
            } else {
                for (const category in VARIABLE_CATEGORIES) {
                    const option = document.createElement("option"); option.value = category; option.text = category; selector.appendChild(option);
                }
            }
        }

        // --- CORE RENDER FUNCTIONS ---
        function updateGroupKPIs(data) {
            document.getElementById("val-pop").textContent = formatNumber(data.pop);
            document.getElementById("val-growth").textContent = (data.growthRate > 0 ? "+" : "") + Math.round(data.growthRate) + "%";
            document.getElementById("val-income").textContent = formatCurrency(data.medInc);
            document.getElementById("val-unemployment").textContent = Math.round(data.unemp) + "%";
            document.getElementById("val-hh-size").textContent = data.hhSize.toFixed(1);
            document.getElementById("val-lep").textContent = Math.round(data.lep) + "%";
        }

        function renderCategoryCharts(categoryName) {
            const grid = document.getElementById("categoryChartsGrid");
            grid.innerHTML = ""; 
            
            charts.categoryCharts.forEach(c => c.destroy());
            charts.categoryCharts = [];

            const variables = VARIABLE_CATEGORIES[categoryName];
            if (!variables) return;

            variables.forEach(variable => {
                if (variable.chart === false) return;

                const card = document.createElement("div");
                card.className = "section-card";
                
                // Add class for taller container if grouped
                const containerClass = variable.grouped ? "chart-container-tall" : "chart-container-category";
                
                card.innerHTML = `
                    <div class="section-header">
                        <div class="section-title">${variable.label}</div>
                    </div>
                    <div class="${containerClass}">
                        <canvas id="chart-${variable.id}"></canvas>
                    </div>
                `;
                grid.appendChild(card);

                const ctx = document.getElementById(`chart-${variable.id}`);
                
                if (variable.grouped) {
                    const chartInstance = createGroupedBarChart(ctx, variable.subMetrics, variable.label);
                    charts.categoryCharts.push(chartInstance);
                } else {
                    const chartInstance = createVariableChart(ctx, variable.id, variable.label);
                    charts.categoryCharts.push(chartInstance);
                }
            });
        }

        function updateDashboard() {
            const mode = document.getElementById('filterMode').value;
            const selectedValue = document.getElementById('primaryFilter').value;
            const activeGroupSpan = document.getElementById("activeGroup");
            const groupView = document.getElementById('group-view-container');
            const categoryView = document.getElementById('category-view-container');
            const dataTableDesc = document.getElementById('dataTableDesc');

            if (mode === 'group') {
                groupView.classList.remove('hidden'); categoryView.classList.add('hidden');
                
                // Update Table Description
                if(dataTableDesc) dataTableDesc.textContent = "This table displays a comprehensive breakdown of all available metrics for every racial and ethnic group.";
                
                populateDataTable(); 
                const data = rawData.find(d => d.group === selectedValue) || rawData[0];
                if (!data) return;
                activeGroupSpan.textContent = data.group;
                updateGroupKPIs(data); renderDetailedView(data); updateGroupCharts(data);
            } else {
                groupView.classList.add('hidden'); categoryView.classList.remove('hidden');
                
                // Update Table Description
                if(dataTableDesc) dataTableDesc.textContent = "This table shows the specific metrics related to the selected category across all racial and ethnic groups.";
                
                const categoryName = selectedValue;
                activeGroupSpan.textContent = categoryName; 
                renderCategoryCharts(categoryName); renderCategoryTable(categoryName);
            }
        }

        function updateGroupCharts(data) {
            const ref = referenceData || data;
            const refLabel = ref.group === "Total Population" ? "Total Pop." : ref.group;
            const colors = PALETTE;
            let mainColor = data.group.toLowerCase().includes("total") ? colors.totalPop : colors.darkBlue;
            let refColor = ref.group.toLowerCase().includes("total") ? colors.totalPop : colors.darkGreen;

            const centerTextPlugin = {
                id: 'centerText',
                beforeDraw: function(chart) {
                    if (chart.config.type !== 'doughnut' || !chart.config.options.elements.center) return;
                    var width = chart.width, height = chart.height, ctx = chart.ctx;
                    ctx.restore();
                    var fontSize = (height / 140).toFixed(2);
                    ctx.font = "bold " + fontSize + "em sans-serif"; ctx.textBaseline = "middle"; ctx.textAlign = "center"; ctx.fillStyle = "#1e293b";
                    var text = chart.config.options.elements.center.text, textX = width / 2, textY = height / 2;
                    ctx.fillText(text, textX, textY - 30);
                    ctx.font = "normal " + (height / 220).toFixed(2) + "em sans-serif"; ctx.fillStyle = "#64748b";
                    ctx.fillText("Workers", textX, textY - 5); 
                    ctx.save();
                }
            };

            const totalWorkers = data.priv + data.gov + data.self + data.unpaid;
            const customLegendGenerator = {
                labels: {
                    usePointStyle: true,
                    generateLabels: function(chart) {
                        const data = chart.data;
                        if (data.labels.length && data.datasets.length) {
                            return data.labels.map((label, i) => {
                                const meta = chart.getDatasetMeta(0); const style = meta.controller.getStyle(i);
                                const value = data.datasets[0].data[i];
                                let total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let pct = Math.round((value / total) * 100) + "%";
                                return { text: `${label}: ${pct}`, fillStyle: style.backgroundColor, strokeStyle: style.borderColor, lineWidth: style.borderWidth, hidden: isNaN(data.datasets[0].data[i]) || meta.data[i].hidden, index: i };
                            });
                        }
                        return [];
                    }
                }
            };

            if (charts.employment) charts.employment.destroy();
            charts.employment = new Chart(document.getElementById('employmentChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Private', 'Government', 'Self-Employed', 'Unpaid Family'],
                    datasets: [{ data: [data.priv, data.gov, data.self, data.unpaid], backgroundColor: [colors.darkBlue, colors.darkGreen, colors.lightBlue, colors.lightGreen], borderColor: '#ffffff', borderWidth: 1 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '65%',
                    elements: { center: { text: formatNumber(totalWorkers) } },
                    plugins: { 
                        legend: { position: 'bottom', labels: customLegendGenerator.labels }, 
                        datalabels: { display: true, color: (ctx) => ctx.dataIndex >= 2 ? '#334155' : '#fff', font: { weight: 'bold', size: DATA_LABEL_FONT_SIZE }, formatter: (val) => { let pct = (val / totalWorkers * 100); return pct > 5 ? Math.round(pct) + '%' : ''; } } 
                    }
                },
                plugins: [centerTextPlugin]
            });

            if (charts.housing) charts.housing.destroy();
            charts.housing = new Chart(document.getElementById('housingChart'), {
                type: 'doughnut', 
                data: {
                    labels: ['Owner Occupied', 'Renter Occupied'],
                    datasets: [{ data: [data.own, data.rent], backgroundColor: [colors.darkBlue, colors.darkGreen] }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '65%',
                    layout: { padding: { bottom: 0 } }, 
                    plugins: { 
                        legend: { position: 'bottom', labels: { ...customLegendGenerator.labels, padding: 20 } }, 
                        datalabels: { display: true, color: '#fff', font: { weight: 'bold', size: DATA_LABEL_FONT_SIZE }, formatter: (val) => Math.round(val) + '%' } 
                    }
                }
            });

            const barOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'top', align: 'end', labels: { usePointStyle: true } }, 
                    datalabels: { 
                        anchor: 'end',
                        align: (ctx) => (ctx.dataset.data[ctx.dataIndex] < 1) ? 'end' : 'start',
                        color: (ctx) => (ctx.dataset.data[ctx.dataIndex] < 1) ? '#334155' : '#fff',
                        font: { weight: 'bold', size: DATA_LABEL_FONT_SIZE }, 
                        formatter: (val) => Math.round(val) + '%' 
                    } 
                },
                scales: { y: { beginAtZero: true, grid: { borderDash: [4, 4] } }, x: { grid: { display: false } } },
                layout: { padding: { top: 25, right: 20 } }
            };

            if (charts.economic) charts.economic.destroy();
            charts.economic = new Chart(document.getElementById('economicChart'), {
                type: 'bar',
                data: {
                    labels: ['Unemployment', 'Poverty', 'Rent Burden'],
                    datasets: [
                        { label: data.group, data: [data.unemp, data.povertyRate, data.burden], backgroundColor: mainColor, borderRadius: 4 },
                        { label: refLabel, data: [ref.unemp, ref.povertyRate, ref.burden], backgroundColor: refColor, borderRadius: 4 }
                    ]
                },
                options: barOptions
            });

            if (charts.lep) charts.lep.destroy();
            charts.lep = new Chart(document.getElementById('lepChart'), {
                type: 'bar',
                data: {
                    labels: ['Age 5-17', 'Age 18-64', 'Age 65+'],
                    datasets: [{ label: 'LEP %', data: [data.lep5_17, data.lep18_64, data.lep65], backgroundColor: [colors.lightBlue, colors.darkBlue, colors.darkGreen], borderRadius: 6, barPercentage: 0.8 }]
                },
                options: { ...barOptions, plugins: { legend: { display: false }, datalabels: { ...barOptions.plugins.datalabels } } }
            });
        }

        function createGroupedBarChart(ctx, subMetrics, label) {
            const majorRaces = ["White", "Black", "Hispanic or Latino (of any race)", "Asian", "American Indian and Alaska Native", "Some Other Race", "Two or More Races"];
            
            let groups = rawData.map(d => d.group).sort((a, b) => {
                const aName = a.toLowerCase(), bName = b.toLowerCase();
                if(aName.includes("total population")) return -1; if(bName.includes("total population")) return 1;
                const aIsRace = majorRaces.includes(a), bIsRace = majorRaces.includes(b);
                if (aIsRace && !bIsRace) return -1; if (!aIsRace && bIsRace) return 1;
                return a.localeCompare(b);
            });

            const data1 = groups.map(g => { const item = rawData.find(r => r.group === g); return item ? item[subMetrics[0].id] : 0; });
            const data2 = groups.map(g => { const item = rawData.find(r => r.group === g); return item ? item[subMetrics[1].id] : 0; });

            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: groups,
                    datasets: [
                        { label: subMetrics[0].label, data: data1, backgroundColor: PALETTE.darkBlue, borderRadius: 3, barPercentage: 0.85, categoryPercentage: 0.85 },
                        { label: subMetrics[1].label, data: data2, backgroundColor: PALETTE.lightGreen, borderRadius: 3, barPercentage: 0.85, categoryPercentage: 0.85 }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { right: 60 } },
                    scales: { x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { precision: 0 } }, y: { grid: { display: false } } },
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: { callbacks: { label: function(context) { let val = context.raw; return Math.round(val) + "%"; } } },
                        datalabels: {
                            anchor: 'end', align: 'end', color: '#334155', font: { weight: 'bold', size: 11 },
                            formatter: (val) => Math.round(val) + "%"
                        }
                    }
                }
            });
        }

        function createVariableChart(ctx, variableKey, label) {
            const majorRaces = ["White", "Black", "Hispanic or Latino (of any race)", "Asian", "American Indian and Alaska Native", "Some Other Race", "Two or More Races"];
            let chartData = rawData.map(d => ({ group: d.group, value: d[variableKey] || 0 }));
            chartData.sort((a, b) => {
                const aName = a.group.toLowerCase(), bName = b.group.toLowerCase();
                if(aName.includes("total population")) return -1; if(bName.includes("total population")) return 1;
                const aIsRace = majorRaces.includes(a.group), bIsRace = majorRaces.includes(b.group);
                if (aIsRace && !bIsRace) return -1; if (!aIsRace && bIsRace) return 1;
                return b.value - a.value;
            });
            const bgColors = chartData.map(d => {
                const name = d.group.toLowerCase();
                if (name.includes("total population")) return PALETTE.totalPop; 
                if (majorRaces.includes(d.group)) return PALETTE.darkBlue; 
                return PALETTE.darkGreen; 
            });

            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.group),
                    datasets: [{
                        label: label, data: chartData.map(d => d.value), backgroundColor: bgColors, borderRadius: 4,
                        barPercentage: 0.85, categoryPercentage: 0.85 
                    }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    layout: { padding: { right: 60 } },
                    scales: { x: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { precision: 0 } }, y: { grid: { display: false } } },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: function(context) { let val = context.raw; if (label.includes("$")) return formatCurrency(val); if (label.includes("%") || label.includes("Rate")) return Math.round(val) + "%"; return formatNumber(val); } } },
                        datalabels: {
                            anchor: 'end', 
                            align: 'end',
                            color: '#334155',
                            font: { weight: 'bold', size: DATA_LABEL_FONT_SIZE },
                            formatter: (val) => {
                                // Specific formatting rules per chart type based on label name
                                if (label.includes("$")) return formatCurrency(val).replace(".00", ""); 
                                if (label.includes("%") || label.includes("Rate") || label.includes("Diversity")) return Math.round(val) + "%";
                                
                                // Default Population / Number handling
                                if (val < 10 && val > 0) return val.toFixed(1); 
                                if (val >= 1000) return formatNumber(val); // Full numbers for Population
                                return val; 
                            }
                        }
                    }
                }
            });
        }

        function renderCategoryTable(categoryName) {
            const thead = document.getElementById("tableHeader"); const tbody = document.getElementById("tableBody");
            const variables = VARIABLE_CATEGORIES[categoryName];
            let headerHTML = `<tr><th>Group</th>`;
            
            variables.forEach(v => { 
                if(v.grouped) {
                    v.subMetrics.forEach(sub => headerHTML += `<th>${sub.label}</th>`);
                } else {
                    headerHTML += `<th>${v.label}</th>`; 
                }
            });
            headerHTML += `</tr>`; thead.innerHTML = headerHTML; tbody.innerHTML = '';
            
            const majorRaces = ["White", "Black", "Hispanic or Latino (of any race)", "Asian", "American Indian and Alaska Native", "Some Other Race", "Two or More Races"];
            let sortedRows = [...rawData].sort((a, b) => {
                 const aName = a.group.toLowerCase(), bName = b.group.toLowerCase();
                 if(aName.includes("total population")) return -1; if(bName.includes("total population")) return 1;
                 const aIsRace = majorRaces.includes(a.group), bIsRace = majorRaces.includes(b.group);
                 if (aIsRace && !bIsRace) return -1; if (!aIsRace && bIsRace) return 1;
                 return a.group.localeCompare(b.group); 
            });

            sortedRows.forEach(item => {
                const row = document.createElement("tr");
                const lowerGroup = item.group.toLowerCase().trim();
                if (lowerGroup.includes("total population")) row.classList.add("row-total-pop");
                else if (majorRaces.includes(item.group)) row.classList.add("row-race-cat");
                else row.classList.add("row-ethnic-grp");

                let rowHTML = `<td class="font-medium">${item.group}</td>`;
                variables.forEach(v => {
                    if (v.grouped) {
                        v.subMetrics.forEach(sub => {
                            let val = item[sub.id]; 
                            let displayVal = Math.round(val) + "%"; 
                            rowHTML += `<td>${displayVal}</td>`;
                        });
                    } else {
                        let val = item[v.id]; let displayVal = formatNumber(val);
                        if (v.label.includes("$")) displayVal = formatCurrency(val).replace(".00", "");
                        else if (v.label.includes("%") || v.label.includes("Rate") || v.id === "growthRate" || v.id === "langDiv") displayVal = Math.round(val) + "%";
                        rowHTML += `<td>${displayVal}</td>`;
                    }
                });
                row.innerHTML = rowHTML; tbody.appendChild(row);
            });
        }

        function getComparisonHTML(val, ref, lowerBetter, fmt) {
            let diffVal = 0, suffix = "", isPositive = false;
            if (fmt === 'pct') { diffVal = val - ref; suffix = "%"; isPositive = diffVal >= 0; }
            else { if (ref !== 0) diffVal = ((val - ref) / ref) * 100; suffix = "%"; isPositive = diffVal >= 0; }
            let isGood = lowerBetter ? !isPositive : isPositive;
            if (Math.abs(diffVal) < 0.1) return `<span class="status-badge text-gray"><i class="fas fa-minus"></i> --</span>`;
            let colorClass = isGood ? "text-green" : "text-red";
            let icon = isPositive ? "fa-arrow-up" : "fa-arrow-down";
            return `<span class="status-badge ${colorClass}"><i class="fas ${icon}"></i> ${Math.abs(diffVal).toFixed(1) + suffix}</span>`;
        }

        function renderDetailedView(data) {
            const container = document.getElementById("detailedViewContainer");
            const ref = referenceData || data; const asi = asianData || data;
            const metrics = [
                { label: "Total Population", val: data.pop, ref: ref.pop, asi: asi.pop, fmt: "num" },
                { label: "Median HH Income", val: data.medInc, ref: ref.medInc, asi: asi.medInc, fmt: "curr" },
                { label: "Per Capita Income", val: data.perCap, ref: ref.perCap, asi: asi.perCap, fmt: "curr" },
                { label: "Unemployment Rate", val: data.unemp, ref: ref.unemp, asi: asi.unemp, fmt: "pct", lowerBetter: true },
                { label: "Poverty Rate", val: data.povertyRate, ref: ref.povertyRate, asi: asi.povertyRate, fmt: "pct", lowerBetter: true },
                { label: "Home Ownership", val: data.own, ref: ref.own, asi: asi.own, fmt: "pct" },
                { label: "Rent Burden", val: data.burden, ref: ref.burden, asi: asi.burden, fmt: "pct", lowerBetter: true },
                { label: "Gross Rent", val: data.grossRent, ref: ref.grossRent, asi: asi.grossRent, fmt: "curr", lowerBetter: true },
                { label: "LEP Rate", val: data.lep, ref: ref.lep, asi: asi.lep, fmt: "pct", lowerBetter: true }
            ];
            let html = "";
            metrics.forEach(m => {
                let displayVal, displayRef, displayAsi;
                if (m.fmt === "curr") { displayVal = formatCurrency(m.val); displayRef = formatCurrency(m.ref); displayAsi = formatCurrency(m.asi); }
                else if (m.fmt === "pct") { displayVal = Math.round(m.val) + "%"; displayRef = Math.round(m.ref) + "%"; displayAsi = Math.round(m.asi) + "%"; }
                else { displayVal = formatNumber(m.val); displayRef = formatNumber(Math.round(m.ref)); displayAsi = formatNumber(Math.round(m.asi)); }
                let statusRef = getComparisonHTML(m.val, m.ref, m.lowerBetter, m.fmt);
                let statusAsi = getComparisonHTML(m.val, m.asi, m.lowerBetter, m.fmt);
                html += `<div class="detailed-row"><div class="col-metric">${m.label}</div><div class="col-value">${displayVal}</div><div class="col-ref-1">${displayRef}</div><div class="col-stat-1">${statusRef}</div><div class="col-ref-2">${displayAsi}</div><div class="col-stat-2">${statusAsi}</div></div>`;
            });
            container.innerHTML = html;
        }

        function populateDataTable() {
            const thead = document.getElementById("tableHeader");
            thead.innerHTML = `
                <tr>
                    <th>Group</th><th>Population</th><th>Foreign Born</th><th>Avg. Household Size</th>
                    <th>Median Income</th><th>Per Capita Income</th><th>Below Poverty Level %</th><th>SNAP %</th>
                    <th>Labor Force %</th><th>Unemployment %</th><th>Emp: Priv</th><th>Emp: Gov</th><th>Emp: Self</th><th>Emp: Fam</th>
                    <th>Without Health Ins. %</th><th>LEP Total %</th><th>LEP 5-17 %</th><th>LEP 18-64 %</th><th>LEP 65+ %</th>
                    <th>Owner %</th><th>Renter %</th><th>Housing Value</th><th>Gross Rent</th><th>Rent Burden %</th>
                </tr>
            `;
            const tbody = document.getElementById("tableBody"); tbody.innerHTML = '';
            const raceCategories = ["white", "black", "american indian and alaska native", "some other race", "two or more races", "hispanic or latino (of any race)", "asian", "asian alone"];
            rawData.forEach(item => {
                const row = document.createElement("tr");
                const lowerGroup = item.group.toLowerCase().trim();
                if (lowerGroup.includes("total population")) row.classList.add("row-total-pop"); 
                else if (raceCategories.includes(lowerGroup)) row.classList.add("row-race-cat");  
                else row.classList.add("row-ethnic-grp");
                row.innerHTML = `
                    <td>${item.group}</td><td>${formatNumber(item.pop)}</td><td>${formatNumber(item.foreignBorn)}</td><td>${item.hhSize.toFixed(2)}</td>
                    <td>${formatCurrency(item.medInc)}</td><td>${formatCurrency(item.perCap)}</td><td>${Math.round(item.povertyRate)}%</td><td>${Math.round(item.snap)}%</td>
                    <td>${Math.round(item.laborForce)}%</td><td>${Math.round(item.unemp)}%</td><td>${formatNumber(item.priv)}</td><td>${formatNumber(item.gov)}</td>
                    <td>${formatNumber(item.self)}</td><td>${formatNumber(item.unpaid)}</td><td>${Math.round(item.healthIns)}%</td><td>${Math.round(item.lep)}%</td>
                    <td>${Math.round(item.lep5_17)}%</td><td>${Math.round(item.lep18_64)}%</td><td>${Math.round(item.lep65)}%</td><td>${Math.round(item.own)}%</td>
                    <td>${Math.round(item.rent)}%</td><td>${formatCurrency(item.housingValue)}</td><td>${formatCurrency(item.grossRent)}</td><td>${Math.round(item.burden)}%</td>
                `;
                row.addEventListener('click', () => { 
                    document.getElementById('filterMode').value = 'group'; populatePrimaryFilter(); document.getElementById('primaryFilter').value = item.group; updateDashboard(); 
                });
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>